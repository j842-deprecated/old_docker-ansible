#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
. $DIR/bash.conf


function getmd5 {
  MD5=$(docker run --name ansiblecopy -v ${VOLUME_NAME}:/config ${CONTAINER_NAME} tar c config/sshkeys | md5sum)
  docker rm ansiblecopy > /dev/null
}

function showusage {
cat <<EOF

NAME
   copykeys - copy the ssh keys to be used by ansible.

SYNOPSIS
   copykeys PATH

DESCRIPTION
   Copy all files from PATH into /root/.ssh in the docker container.

RETURN VALUE
   0   - success
   1   - error
   
EOF
   exit 1
}


RVAL=3

if [ -z $1 ]; then
  showusage
fi
if [ ! -d $1 ]; then
  echo "Directory $1 does not exist."
  exit 1
fi

  
# add the directory
# -- docker cp does not work on the new volume containers. >.<
echo "Copying from ${1}."

getmd5
OLDMD5=${MD5}

# can't use --rm or it kills the volume container. :/
docker run --name ansiblecopy -v ${VOLUME_NAME}:/config -v ${1}:/tmp/sshkeys ${CONTAINER_NAME} /bin/cp -a /tmp/sshkeys/ /config
RVAL=$?
docker rm ansiblecopy > /dev/null
  
getmd5  
if [ "${MD5}" = "${OLDMD5}" ]; then
   echo "Keys unchanged."
   exit 3
fi
  
echo "Keys updated."
exit $RVAL

