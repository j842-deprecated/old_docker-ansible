#!/bin/bash

# Script to install docker and the 842/ansible container on a clean
# Debian machine.
# Should be idempotent and suitable for use from Ansible.

# return value:
#     0 if success
#     1 if error
#     3 if nothing changed

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit 1
fi

IMAGENAME="j842/ansible"
RVAL=3
UPDATED=0

if [ $(uname -rv | grep -c "Debian") -eq 0 ]; then
  echo "This script is only for Debian hosts."
  exit 1
fi

# install package if it doesn't exist, updating cache
function checkinstall {
if [ $(dpkg-query -W -f='${Status}' ${1} 2>/dev/null | grep -c "ok installed") -eq 0 ];
then
  if [ ${UPDATED} -eq 0 ]; then
	apt-get update
	UPDATED=1
  fi
  apt-get install -y ${1};
  RVAL=0
fi
}

# create a command which is run via docker
function makefile {
  if [ ! -e /usr/local/bin/$1 ]; then
    cat <<EOF | tr -s ' ' >/usr/local/bin/$1 
#!/bin/bash

docker run --name=ansible -ti --rm                              \
       -v "/root/dockeransible/ansible:/data"                   \
       -v "/root/dockeransible/sshkeys:/sshkeys"                \
       -v "/root/dockeransible/ansible.cfg:/root/.ansible.cfg"  \
       ${IMAGENAME} /usr/local/bin/ansiblerun $1 \$@
EOF
    chmod a+x /usr/local/bin/$1
    RVAL=0
fi 
}

# ------------ INSTALL DOCKER --------------------------

if [ ! -e /usr/local/bin/install_docker.sh ]; then
   checkinstall wget
   wget -nv -O /usr/local/bin/install_docker.sh \
        https://raw.github.com/j842/scripts/master/install_docker.sh
   chmod u+x /usr/local/bin/install_docker.sh
   RVAL=0
fi
/usr/local/bin/install_docker.sh
RVAL=$?

# ------------ CONFIGURE ANSIBLE CONTAINER --------------------------

# configure ansible commands
COMMANDS=(ansible ansible-doc ansible-galaxy ansible-playbook ansible-pull ansible-vault)
for CMD in ${COMMANDS[@]}; do
  makefile $CMD
done

# get the latest docker image, set RVAL if changed.
if [ $(docker pull ${IMAGENAME} | grep -c "Image is up to date") -eq 0 ]; then
  RVAL=0
fi

#------------------------

exit ${RVAL}
