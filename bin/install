#!/bin/bash

# Script to install the ansible commands on a clean Debian machine.
# Uses the Docker-Ansible image. Assumes Docker is already installed.
# Should be idempotent and suitable for use from Ansible.

# return value:
#     0 if success
#     1 if error
#     3 if nothing changed

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
. "$DIR/bash.conf"

GETPATH="${BINDIR}/ansible-getpath"
RVAL=3

function showusage {
cat <<EOF >&2

NAME
   install - Script to install ansiblesession
   
SYNOPSIS
   install

DESCRIPTION
   Installs ansiblesession to ${BINDIR}.
   
RETURN VALUE
   0   - success
   1   - error
   
EOF
   exit 1  
}

# create a command which is run via docker
# translates pwd to suitable path in docker container under /data.
# could run through all arguments and translate paths there too....
function makefile {
  if [ ! -e "${BINDIR}/${1}" ]; then

    PATHFILE="~/.ansiblepath"

    cat <<EOF | tr -s ' ' >"${BINDIR}/$1"
#!/bin/bash

# This script was installed as part of docker-ansible.
# More info here:
#   https://github.com/j842/docker-ansible

# determine path to mount into container.
ANSIBLE_PATH="\$1"
if [ -z "\$ANSIBLE_PATH" ]; then
   if [ -e "$PATHFILE" ]; then
     ANSIBLE_PATH=$(<"$PATHFILE")
   else
     ANSIBLE_PATH=$(<pwd)
   fi
fi

if [ ! -d "\$ANSIBLE_PATH" ]; then echo "Path does not exist: \$ANSIBLE_PATH" ; exit 1 ; fi

ANSIBLE_VCMD="\${ANSIBLE_PATH}:${ANSIBLE_MOUNT}"

# determine where pwd is in terms of the ansible container
ANSIBLE_CDIR=\$(${GETPATH} "\$ANSIBLE_PATH")
if [ \$? -ne 0 ]; then exit 1 ; fi

# run the command in the container
docker run --name=${1} -ti                           \
       -v "${VOLUME_VCMD}" -v "\${ANSIBLE_VCMD}"         \
       ${CONTAINER_NAME} ${BINDIR}/ansiblerun \${ANSIBLE_CDIR}
docker rm ${1}  > /dev/null
EOF
    chmod a+x ${BINDIR}/"$1"
    echo "Created ${BINDIR}/$1"
    RVAL=0
fi 
}


# check we're root on Debian and Docker is installed
if [ "$EUID" -ne 0 ]; then 
  echo "Please run as root"
  exit 1
fi
if [ $(uname -rv | grep -c "Debian") -eq 0 ]; then
  echo "This script is only for Debian hosts."
  exit 1
fi
if ! command_exists docker ; then 
  echo "Docker needs to be installed first."
  exit 1
fi
if [ $# -ne 0 ]; then showusage ; fi

# ------------ CONFIGURE ANSIBLE CONTAINER --------------------------

# put supporting script (ansible-getpath) in usr/local/bin
diff "${DIR}/support/ansible-getpath" "${GETPATH}" >/dev/null 2>&1
if [ $? -ne 0 ]; then 
  cp ${DIR}/support/ansible-getpath "${GETPATH}"
  chmod a+x "${GETPATH}"
  RVAL=0
fi

# configure ansiblesession.
makefile ansiblesession

#------------------------

exit ${RVAL}
